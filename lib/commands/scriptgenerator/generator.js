/*** Generated by streamline 0.4.5 (callbacks) - DO NOT EDIT ***/ var __rt=require('streamline/lib/callbacks/runtime').runtime(__filename),__func=__rt.__func,__cb=__rt.__cb; var fs = require("fs");
var path = require("path");
var utils = require("../../utils");

if (!fs.existsSync) {
  fs.existsSync = pathUtil.existsSync;};


var templatesDir = __dirname;
var log = { info: function() {  }};
var confirm = function() { return false;};

exports.generateDeploymentScript = function exports_generateDeploymentScript__1(repositoryRoot, projectType, projectPath, solutionPath, sitePath, scriptType, noDotDeployment, logger, confirmFunc, _) { var relativeProjectPath, relativeSolutionPath, relativeSitePath; var __frame = { name: "exports_generateDeploymentScript__1", line: 13 }; return __func(_, this, arguments, exports_generateDeploymentScript__1, 9, __frame, function __$exports_generateDeploymentScript__1() {
    argNotNull(repositoryRoot, "repositoryRoot");
    argNotNull(projectType, "projectType");
    argNotNull(scriptType, "scriptType");
    argNotNull(sitePath, "sitePath");

    scriptType = scriptType.toUpperCase();
    if (((scriptType != "BATCH") && (scriptType != "BASH"))) {
      return _(new Error("Script type should be either batch or bash")); } ;


    log = (logger || log);
    confirm = (confirmFunc || confirm);

    if (projectPath) {
      if (!isPathSubDir(repositoryRoot, projectPath)) {
        return _(new Error("The project file path should be a sub-directory of the repository root")); } ;


      relativeProjectPath = path.relative(repositoryRoot, projectPath);
      log.info((("Project file path: ." + path.sep) + relativeProjectPath)); } ;


    if (solutionPath) {
      if (!isPathSubDir(repositoryRoot, solutionPath)) {
        return _(new Error("The solution file path should be the same as repository root or a sub-directory of it.")); } ;


      relativeSolutionPath = path.relative(repositoryRoot, solutionPath);
      log.info((("Solution file path: ." + path.sep) + relativeSolutionPath)); } ;


    if (!isPathSubDir(repositoryRoot, sitePath)) {
      return _(new Error("The site directory path should be the same as repository root or a sub-directory of it.")); } ;


    relativeSitePath = path.relative(repositoryRoot, sitePath);
    if (relativeSitePath) {
      relativeSitePath = (path.sep + relativeSitePath);
      log.info(("The site directory path: ." + relativeSitePath)); } ;


    projectType = projectType.toUpperCase(); return (function __$exports_generateDeploymentScript__1(__then) {
      if ((projectType === "WAP")) {
        return generateWapDeploymentScript(repositoryRoot, relativeProjectPath, relativeSolutionPath, scriptType, relativeSitePath, noDotDeployment, __cb(_, __frame, 44, 8, __then, true)); } else { return (function __$exports_generateDeploymentScript__1(__then) {

          if ((projectType === "WEBSITE")) {
            return generateWebSiteDeploymentScript(repositoryRoot, relativeSolutionPath, scriptType, relativeSitePath, noDotDeployment, __cb(_, __frame, 47, 8, __then, true)); } else { return (function __$exports_generateDeploymentScript__1(__then) {

              if ((projectType === "NODE")) {
                return generateNodeDeploymentScript(repositoryRoot, scriptType, relativeSitePath, noDotDeployment, __cb(_, __frame, 50, 8, __then, true)); } else { return (function __$exports_generateDeploymentScript__1(__then) {

                  if ((projectType === "BASIC")) {
                    if (solutionPath) {
                      return _(new Error("Solution path is not supported with this website type")); } ;

                    return generateWebSiteDeploymentScript(repositoryRoot, relativeSolutionPath, scriptType, relativeSitePath, noDotDeployment, __cb(_, __frame, 56, 8, __then, true)); } else {


                    return _(new Error(("Invalid project type received: " + projectType))); } ; })(__then); } ; })(__then); } ; })(__then); } ; })(_); });};



function isPathSubDir(parentPath, childPath) {
  var relativePath = path.relative(parentPath, childPath);




  return ((relativePath.indexOf("..") != 0) && (relativePath != path.resolve(childPath)));};



function generateNodeDeploymentScript(repositoryRoot, scriptType, sitePath, noDotDeployment, _) { var __frame = { name: "generateNodeDeploymentScript", line: 86 }; return __func(_, this, arguments, generateNodeDeploymentScript, 4, __frame, function __$generateNodeDeploymentScript() {
    argNotNull(repositoryRoot, "repositoryRoot");

    createIisNodeWebConfigIfNeeded(repositoryRoot);
    return utils.copyIisNodeWhenServerJsPresent(log, repositoryRoot, __cb(_, __frame, 4, 4, function __$generateNodeDeploymentScript() {

      return generateBasicDeploymentScript("node.template", scriptType, repositoryRoot, sitePath, noDotDeployment, __cb(_, __frame, 6, 4, _, true)); }, true)); });};


function getNodeStartFile(repositoryRoot) {
  var nodeStartFiles = ["server.js","app.js",];

  for (var i in nodeStartFiles) {
    var nodeStartFilePath = path.join(repositoryRoot, nodeStartFiles[i]);

    if (fs.existsSync(nodeStartFilePath)) {
      return nodeStartFiles[i]; } ; };



  return null;};


function createIisNodeWebConfigIfNeeded(repositoryRoot) {
  var webConfigPath = path.join(repositoryRoot, "web.config");

  log.info("Generating deployment script for node.js Web Site");

  if (!fs.existsSync(webConfigPath)) {
    log.info("Creating Web.config to enable Node.js activation.");

    var nodeStartFilePath = getNodeStartFile(repositoryRoot);
    if (!nodeStartFilePath) {
      throw new Error("Missing server.js/app.js file which is required for a node.js site"); } ;


    var webConfigContent = getTemplateContent("iisnode.config.template");
    webConfigContent = webConfigContent.replace(/{NodeStartFile}/g, nodeStartFilePath);

    writeContentToFile(webConfigPath, webConfigContent); };};



function generateWapDeploymentScript(repositoryRoot, projectPath, solutionPath, scriptType, sitePath, noDotDeployment, _) { var msbuildArguments; var __frame = { name: "generateWapDeploymentScript", line: 129 }; return __func(_, this, arguments, generateWapDeploymentScript, 6, __frame, function __$generateWapDeploymentScript() {
    argNotNull(repositoryRoot, "repositoryRoot");
    argNotNull(projectPath, "projectPath");

    if ((scriptType != "BATCH")) {
      return _(new Error("Only batch script files are supported for .NET Web Application")); } ;


    log.info("Generating deployment script for .NET Web Application");

    msbuildArguments = (("\"%DEPLOYMENT_SOURCE%\\" + projectPath) + "\" /nologo /verbosity:m /t:pipelinePreDeployCopyAllFilesToOneFolder /p:_PackageTempDir=\"%DEPLOYMENT_TEMP%\";AutoParameterizationWebConfigConnectionStrings=false;Configuration=Release");
    if ((solutionPath != null)) {
      msbuildArguments += ((" /p:SolutionDir=\"%DEPLOYMENT_SOURCE%\\" + solutionPath) + "\""); } ;


    return generateDotNetDeploymentScript("deploy.batch.aspnet.wap.template", msbuildArguments, repositoryRoot, sitePath, noDotDeployment, __cb(_, __frame, 15, 4, _, true)); });};


function generateWebSiteDeploymentScript(repositoryRoot, solutionPath, scriptType, sitePath, noDotDeployment, _) { var msbuildArguments; var __frame = { name: "generateWebSiteDeploymentScript", line: 147 }; return __func(_, this, arguments, generateWebSiteDeploymentScript, 5, __frame, function __$generateWebSiteDeploymentScript() { return (function __$generateWebSiteDeploymentScript(__then) {
      if (solutionPath) {

        log.info("Generating deployment script for .NET Web Site");

        if ((scriptType != "BATCH")) {
          return _(new Error("Only batch script files are supported for .NET Web Site")); } ;


        msbuildArguments = (("\"%DEPLOYMENT_SOURCE%\\" + solutionPath) + "\" /verbosity:m /nologo");
        return generateDotNetDeploymentScript("deploy.batch.aspnet.website.template", msbuildArguments, repositoryRoot, sitePath, noDotDeployment, __cb(_, __frame, 10, 8, __then, true)); } else {



        return generateBasicDeploymentScript("basic.template", scriptType, repositoryRoot, sitePath, noDotDeployment, __cb(_, __frame, 14, 8, __then, true)); } ; })(_); });};



function generateBasicDeploymentScript(templateFileName, scriptType, repositoryRoot, sitePath, noDotDeployment, _) { var lowerCaseScriptType, templateContent; var __frame = { name: "generateBasicDeploymentScript", line: 165 }; return __func(_, this, arguments, generateBasicDeploymentScript, 5, __frame, function __$generateBasicDeploymentScript() {
    argNotNull(templateFileName, "templateFileName");

    log.info("Generating deployment script for Web Site");

    lowerCaseScriptType = scriptType.toLowerCase();





    templateContent = getTemplatesContent([(("deploy." + lowerCaseScriptType) + ".prefix.template"),((("deploy." + lowerCaseScriptType) + ".") + templateFileName),(("deploy." + lowerCaseScriptType) + ".postfix.template"),]).replace(/{SitePath}/g, sitePath);

    return writeDeploymentFiles(templateContent, scriptType, repositoryRoot, noDotDeployment, __cb(_, __frame, 13, 4, _, true)); });};


function generateDotNetDeploymentScript(templateFileName, msbuildArguments, repositoryRoot, sitePath, noDotDeployment, _) { var templateContent; var __frame = { name: "generateDotNetDeploymentScript", line: 181 }; return __func(_, this, arguments, generateDotNetDeploymentScript, 5, __frame, function __$generateDotNetDeploymentScript() {
    argNotNull(templateFileName, "templateFileName");








    templateContent = getTemplatesContent(["deploy.batch.prefix.template","deploy.batch.aspnet.template",templateFileName,"deploy.batch.postfix.template",]).replace(/{MSBuildArguments}/g, msbuildArguments).replace(/{SitePath}/g, sitePath);

    return writeDeploymentFiles(templateContent, "BATCH", repositoryRoot, noDotDeployment, __cb(_, __frame, 12, 4, _, true)); });};


function getTemplatesContent(fileNames) {
  var content = "";

  for (var i in fileNames) {
    content += getTemplateContent(fileNames[i]); };


  return content;};


function writeDeploymentFiles(templateContent, scriptType, repositoryRoot, noDotDeployment, _) { var deployScriptFileName, deploymentCommand, deployScriptPath, deploymentFilePath; var __frame = { name: "writeDeploymentFiles", line: 206 }; return __func(_, this, arguments, writeDeploymentFiles, 4, __frame, function __$writeDeploymentFiles() {
    argNotNull(templateContent, "templateContent");



    if ((scriptType == "BATCH")) {
      deployScriptFileName = "deploy.cmd";
      deploymentCommand = deployScriptFileName; }

     else {
      deployScriptFileName = "deploy.sh";
      deploymentCommand = ("bash " + deployScriptFileName); } ;


    deployScriptPath = path.join(repositoryRoot, deployScriptFileName);
    deploymentFilePath = path.join(repositoryRoot, ".deployment");


    return writeContentToFile(deployScriptPath, templateContent, __cb(_, __frame, 18, 4, function __$writeDeploymentFiles() { return (function __$writeDeploymentFiles(__then) {

        if (!noDotDeployment) {

          return writeContentToFile(deploymentFilePath, ("[config]\ncommand = " + deploymentCommand), __cb(_, __frame, 22, 8, __then, true)); } else { __then(); } ; })(function __$writeDeploymentFiles() {


        log.info("Generated deployment script files"); _(); }); }, true)); });};


function getTemplateContent(templateFileName) {
  return fs.readFileSync(getTemplatePath(templateFileName), "utf8");};


function getTemplatePath(fileName) {
  return path.join(templatesDir, fileName);};


function writeContentToFile(path, content, _) { var __frame = { name: "writeContentToFile", line: 242 }; return __func(_, this, arguments, writeContentToFile, 2, __frame, function __$writeContentToFile() { return (function __$writeContentToFile(__then) {

      if (fs.existsSync(path)) {
        return confirm((("The file: \"" + path) + "\" already exists\nAre you sure you want to overwrite it (y/n): "), __cb(_, __frame, 3, 13, function ___(__0, __2) { var __1 = !__2; return (function __$writeContentToFile(__then) { if (__1) { return _(null); } else { __then(); } ; })(__then); }, true)); } else { __then(); } ; })(function __$writeContentToFile() {





      return fs.writeFile(path, content, __cb(_, __frame, 9, 4, _, true)); }); });};


function argNotNull(arg, argName) {
  if (((arg === null) || (arg === undefined))) {
    throw new Error((("The argument '" + argName) + "' is null")); };};